#!/usr/bin/env python3
import sqlite3
import urllib.request
import os

def download_cover(url, filename):
    """下载封面图片"""
    try:
        headers = {'User-Agent': 'Mozilla/5.0'}
        req = urllib.request.Request(url, headers=headers)
        with urllib.request.urlopen(req, timeout=10) as response:
            with open(filename, 'wb') as f:
                f.write(response.read())
        return True
    except:
        return False

# 10本热门小说数据
novels = [
    {
        'title': '诡秘之主', 'author': '爱潜水的乌贼',
        'cover': 'https://bookcover.yuewen.com/qdbimg/349573/1010868264/300',
        'desc': '蒸汽与机械的时代，神秘学与超凡者并存的世界。周明瑞穿越到维多利亚时代的异世界，成为克莱恩·莫雷蒂。在这个充满神秘的世界里，他加入塔罗会，一步步揭开世界的真相...',
        'rating': 9.5,
        'chapter': '第一章 深红', 
        'content': '''周明瑞猛地从床上坐起，神色间满是迷茫。深红如潮水般褪去，只剩下一片黑暗。他在黑暗中摸索着，试图点亮煤气灯。

"这是哪里？我不是在公司加班吗？"周明瑞揉了揉太阳穴，头痛欲裂。

记忆开始涌来——他现在叫克莱恩·莫雷蒂，鲁恩王国贝克兰德市的一名历史系大学毕业生。昨晚，他和几个同学尝试了一个神秘学仪式，然后失去了意识。

墙上的挂钟显示是凌晨四点。窗外是雾蒙蒙的街道，煤气路灯在薄雾中散发着昏黄的光芒。这是一个类似维多利亚时代的世界，但又有所不同——这里有真正的神秘，有超凡力量。

克莱恩走到书桌前，看到桌上摆放着几本笔记本和一些占卜工具。他翻开笔记本，里面记载着各种神秘学知识和符号。突然，他的眼前出现了一片深红色的光芒，一个古老的声音在耳边回响："欢迎来到灰雾之上......"'''
    },
    {
        'title': '全职高手', 'author': '蝴蝶蓝',
        'cover': 'https://bookcover.yuewen.com/qdbimg/349573/1887208/300',
        'desc': '网游荣耀中的顶级高手叶修，遭遇俱乐部驱逐，不得不离开职业圈。他在网吧当网管时，在荣耀新开的第十区重新投入游戏，带着十年游戏经验和记忆，开始了重返巅峰的征程...',
        'rating': 9.3,
        'chapter': '第一章 荣耀',
        'content': '''深夜，兴欣网咖二楼。叶修坐在47号机前，手指在键盘上飞快敲击着。屏幕上，他的角色君莫笑正在刷着新区的副本。

"叶哥，这么晚还不睡？"网管小唐端着咖啡走过来。

"睡什么睡，第十区刚开，得抓紧时间升级。"叶修头也不抬地说。

谁能想到，这个在网吧当网管的男人，曾经是荣耀职业联赛的传奇选手？三连冠的战队队长，最强战术大师叶秋。但一年前，因为年龄和俱乐部的压力，他被迫退役。

现在，他在兴欣网咖打工，用公共账号在新区重新开始。没有了顶级账号卡，没有了银武，但他有的是十年荣耀经验和对游戏的热爱。

"君莫笑......"叶修看着这个新建的角色，嘴角露出一丝笑意，"就让我看看，一个散人职业，能不能重返职业赛场。"

手速飞快，操作如行云流水。这一刻，叶修找回了那种久违的感觉——那是属于荣耀，属于竞技的热血。'''
    },
    {
        'title': '庆余年', 'author': '猫腻',
        'cover': 'https://bookcover.yuewen.com/qdbimg/349573/1003354631/300',
        'desc': '范闲从小体弱多病，在五竹叔的照看下，跟随费介学习毒术与医道。离开小城澹州，前往京都。在那里，他经历了朝堂、江湖、庙堂的种种考验，终于发现了这个世界的秘密...',
        'rating': 9.4,
        'chapter': '第一章 一日再活',
        'content': '''黑暗中，意识逐渐苏醒。范闲睁开眼睛，看到的是陌生的木质天花板和摇曳的烛光。

"我这是......"他想说话，却发现自己发不出声音，身体也无法动弹。

"少爷醒了！"旁边传来惊喜的声音。

范闲努力转动眼珠，看到一个穿着古装的丫鬟正激动地看着他。这时他才意识到，自己似乎变成了一个婴儿。

"重生了？还是穿越了？"范闲在心中苦笑。

前世的他是个重度肌无力患者，每天只能躺在病床上，靠着电脑和书籍度日。母亲叶轻眉留给他一个神秘的箱子，里面装着一些奇怪的东西和一本功法。

现在，他成了范家的私生子，母亲叶轻眉在生他时难产而死，留下了一个蒙着黑布的神秘守护者——五竹叔。

窗外传来雨声。澹州的夜晚很静，只有雨滴打在屋檐上的声音。范闲在黑暗中想着：既然来到这个世界，就要好好活一次。'''
    },
    {
        'title': '琅琊榜', 'author': '海宴',
        'cover': 'https://bookcover.yuewen.com/qdbimg/349573/2339323/300',
        'desc': '麒麟才子梅长苏，琅琊榜首，江左盟宗主。他实则是赤焰军少帅林殊，昔日赤焰军惨遭陷害，他死里逃生但容貌尽毁。十二年后，他化名苏先生回到帝都金陵，开始为昭雪冤案、扶持新君的复仇计划...',
        'rating': 9.2,
        'chapter': '第一章 麒麟才子',
        'content': '''金陵城，秋意渐浓。梅岭山庄门前，一辆简朴的马车缓缓停下。

车帘掀起，走出一位白衣书生。他面容清秀，却带着病态的苍白，手中握着一柄折扇。正是琅琊榜首、江左盟宗主——梅长苏。

"先生，金陵城到了。"车夫恭敬地说。

梅长苏点了点头，目光望向远处巍峨的皇宫。十二年了，他终于回到了这个让他恨得入骨的地方。

当年，他是赤焰军少帅林殊，统领三万赤焰铁骑，战无不胜。但一场梅岭惨案，让赤焰军全军覆没，他的父亲、兄弟全部死于非命。他侥幸生还，却容貌尽毁，身中火寒之毒，从此不得不以病弱之身示人。

"谢玉、夏江......"梅长苏喃喃自语，眼中闪过一丝寒光，"当年的血债，该清算了。"

他轻摇折扇，在秋风中走向金陵城。这一次，他要用智谋和布局，为赤焰军昭雪，为冤死的七万将士讨回公道。'''
    },
    {
        'title': '盗墓笔记', 'author': '南派三叔',
        'cover': 'https://bookcover.yuewen.com/qdbimg/349573/1781782/300',
        'desc': '五十年前的长白山发生的事，五十年后重新开始。吴邪从爷爷的古董铺接手了一件青铜器，卷入了一场惊心动魄的盗墓之旅。他和闷油瓶、胖子组成铁三角，探索古墓背后的惊天秘密...',
        'rating': 8.9,
        'chapter': '第一章 血尸',
        'content': '''杭州，吴家古董铺。夏日午后，蝉鸣声此起彼伏。

吴邪坐在柜台后面，百无聊赖地翻着一本旧书。自从爷爷去世后，这家古董铺就由他打理。但对于古董，他其实并不太懂。

"小三爷在吗？"门口传来粗犷的声音。

吴邪抬头，看到一个胖胖的中年男人走了进来。这人叫王胖子，是爷爷的老朋友。

"胖爷，您来了。"吴邪起身打招呼。

"听说你爷爷留了点东西给你？"胖子神秘兮兮地说，"关于长白山那次的。"

吴邪一愣。爷爷临终前确实给了他一个笔记本，里面记载着五十年前在长白山的探险经历。那些离奇诡异的描述，让他一直以为那只是爷爷编的故事。

"胖爷，您说的是哪次？"

"战国帛书，西王母古墓，还有......"胖子压低声音，"血尸。"

那一刻，吴邪不知道，他即将卷入一场延续了半个世纪的惊天谜团。'''
    },
    {
        'title': '鬼吹灯', 'author': '天下霸唱',
        'cover': 'https://bookcover.yuewen.com/qdbimg/349573/1029374/300',
        'desc': '胡八一和胖子王凯旋因为盗墓遭遇诡异事件，随后与Shirley杨组队，凭借祖传的风水秘术，在各大古墓中寻找精绝古城的秘密。摸金校尉的传人，在地底世界探索着神秘的古代文明...',
        'rating': 8.8,
        'chapter': '第一章 精绝古城',
        'content': '''北京，八十年代末。

我叫胡八一，以前当过兵，下过乡，现在在北京一家贸易公司上班。这年头工资低，日子过得紧巴巴的。

这天，我的老战友王凯旋，外号胖子，找到我说："老胡，咱别在这干耗着了，我有个发财的路子。"

"什么路子？"我警觉地问。

"倒斗啊！"胖子神秘兮兮地说，"你不是有本《十六字阴阳风水秘术》吗？咱们去搞点古董，能卖大价钱。"

我犹豫了。那本秘术是我祖上传下来的，据说是清代摸金校尉的心得。摸金校尉，历史上四大盗墓门派之一，以精通风水阴阳著称。

"这事不好办，下墓风险大。"我说。

"怕什么，富贵险中求！"胖子拍着胸脯，"再说了，咱们找个靠谱的墓，下去看看，不一定动手。"

就这样，我和胖子踏上了盗墓的不归路。那时的我不知道，等待我们的，是一个埋藏了两千年的惊天秘密——精绝古城。'''
    },
    {
        'title': '斗破苍穹', 'author': '天蚕土豆',
        'cover': 'https://bookcover.yuewen.com/qdbimg/349573/1535896/300',
        'desc': '萧炎，曾经的天才少年，十岁拥有九段斗之气。三年后斗气突然消失，沦为废物。在婚约被退的羞辱下，他体内的戒指中的药老苏醒，帮助他重新修炼。从此踏上复仇之路，向着斗气大陆的巅峰前进...',
        'rating': 9.0,
        'chapter': '第一章 陨落的天才',
        'content': '''萧家，乌坦城的三大家族之一。萧家演武场上，一位少年正盘腿而坐，双眸紧闭。

"萧炎，你还在浪费时间修炼吗？"讥笑声从旁边传来。

少年睁开眼睛，眼中闪过一丝痛苦和不甘。他叫萧炎，曾经是萧家年轻一辈中最耀眼的天才。十岁时，他就拥有九段斗之气，轰动整个乌坦城。

但三年前，一切都变了。他体内的斗之气莫名其妙地消失，从天才变成了废物。族人的嘲笑，朋友的疏远，让他痛不欲生。

最让他无法接受的是，纳兰家族派人来退婚了。纳兰嫣然，曾经的未婚妻，现在却亲自来到萧家，当众退婚。

"萧炎，对不起。你现在已经配不上我了。"少女冷漠的声音，让萧炎的心如刀割。

"三十年河东，三十年河西，莫欺少年穷！"萧炎咬牙切齿地说。

夜深人静，萧炎回到房间。他摘下手上的黑色戒指，这是母亲留给他的遗物。突然，戒指发出微弱的光芒，一个苍老的声音响起："小家伙，终于等到你了......"'''
    },
    {
        'title': '凡人修仙传', 'author': '忘语',
        'cover': 'https://bookcover.yuewen.com/qdbimg/349573/1887579/300',
        'desc': '韩立，一个山村少年，因为家贫被送入七玄门。他资质平庸，却意外获得了一个神秘的绿色小瓶，能够催熟灵药。凭借小瓶和坚韧的性格，他在修仙界摸爬滚打，从炼气期一路修炼到化神期...',
        'rating': 9.3,
        'chapter': '第一章 山村少年',
        'content': '''青牛镇，一个偏僻的小山村。韩立站在村口，看着前方的山路。

今天，是七玄门每年一度招收弟子的日子。韩立的父母咬咬牙，决定把他送去七玄门试试运气。家里太穷了，如果韩立能入门学点本事，将来也好有个出路。

"韩立，好好努力，别给家里丢脸。"父亲拍了拍他的肩膀。

"知道了，爹。"韩立点点头，心中有些忐忑。

七玄门的考核很严格，主要测试弟子的资质。韩立知道自己资质平庸，能不能通过全看运气。

到了七玄门，韩立和其他孩子一起排队测试。当测灵石放在他手上时，只发出微弱的光芒。

"中下资质，勉强合格。"测试的长老皱了皱眉，"你可以进入外门做杂役弟子。"

就这样，韩立成了七玄门最底层的杂役弟子。他被分配去药园浇水，每天起早贪黑。但韩立并不气馁，他相信只要努力，总有出头的一天。

一个月后，韩立在药园中发现了一个奇怪的小瓶子。当他滴血在上面时，小瓶竟然融入了他的掌心。更神奇的是，这个小瓶能够催熟灵药......'''
    },
    {
        'title': '雪中悍刀行', 'author': '烽火戏诸侯',
        'cover': 'https://bookcover.yuewen.com/qdbimg/349573/1004608738/300',
        'desc': '徐凤年，北凉王世子，表面上纨绔不堪，实则胸怀天下。他游历江湖三年，遍访天下高手，只为在父亲死后，能够撑起北凉三十万铁骑。这是一个关于江湖、庙堂、武道的传奇故事...',
        'rating': 9.1,
        'chapter': '第一章 世子殿下',
        'content': '''北凉王府，大雪纷飞。徐凤年站在城楼上，看着远处白茫茫的雪景。

"世子，王爷让你去书房。"管家小心翼翼地说。

徐凤年笑了笑："知道了，这就去。"

在外人眼中，徐凤年是个不学无术的纨绔子弟，整天游手好闲，不务正业。但只有他自己知道，这都是父亲徐骁安排的。

书房里，北凉王徐骁正在看地图。这位从尸山血海中杀出来的枭雄，如今已经白发苍苍。

"凤年，过几天你就出发吧。"徐骁头也不抬地说，"游历三年，走遍天下，见识江湖高手。"

"是，父王。"徐凤年躬身应道。

"记住，你是北凉世子，将来要统领三十万铁骑。江湖的水很深，多看多学，少说话。"

"孩儿明白。"

几天后，徐凤年带着老仆和一柄木马牛，离开了北凉王府。雪中，他回头看了一眼巍峨的王府，心中暗暗发誓：三年后归来，定要让北凉铁骑威震天下。'''
    },
    {
        'title': '择天记', 'author': '猫腻',
        'cover': 'https://bookcover.yuewen.com/qdbimg/349573/1887204/300',
        'desc': '陈长生十四岁时离开师父下山，带着一纸婚书来到神都。他身患绝症，命不过二十，为了改命逆天，他进入国教学院修行。在这个人、魔、妖共存的世界，他一步步揭开身世之谜，最终改写命运...',
        'rating': 8.7,
        'chapter': '第一章 启程',
        'content': '''西宁镇，道观前。陈长生背着简单的行囊，向师父告别。

"师父，弟子这就下山了。"

老道士点了点头："记住，你身患顽疾,命不过二十。去神都，找那位国教圣女，她或许能帮你改命。"

陈长生接过师父递来的婚书，这是他父母留下的。婚书上写着，他与国教圣女徐有容有婚约。

"师父，我会活下去的。"

神都，大周王朝的国都，繁华无比。陈长生第一次见到如此壮观的城市，心中震撼不已。

按照地址，他来到了国教学院。守门的老者看了看他的婚书，冷笑道："就凭你，也想娶圣女？"

"我只是想进学院读书，寻找改命的方法。"陈长生诚恳地说。

"国教学院不是什么人都能进的。"老者不屑地说，"你连命星都看不见吧？"

命星，是修行者的根基。陈长生确实看不见自己的命星，这意味着他根本无法修行。但他不会放弃，因为他只有六年好活了。'''
    }
]

def main():
    # 确保 covers 目录存在
    os.makedirs('covers', exist_ok=True)
    
    conn = sqlite3.connect('novels.db')
    cursor = conn.cursor()
    
    for i, novel in enumerate(novels, 1):
        print(f"处理 {i}/10: {novel['title']}")
        
        # 下载封面
        cover_file = f"covers/{novel['title']}.jpg"
        print(f"  下载封面...")
        if download_cover(novel['cover'], cover_file):
            cover_url = f"/covers/{novel['title']}.jpg"
        else:
            cover_url = novel['cover']
        
        # 检查是否已存在
        cursor.execute('SELECT id FROM novels WHERE title = ?', (novel['title'],))
        existing = cursor.fetchone()
        
        if existing:
            novel_id = existing[0]
            print(f"  更新现有小说...")
            cursor.execute('''
                UPDATE novels SET author=?, cover_url=?, description=?, rating=?
                WHERE id=?
            ''', (novel['author'], cover_url, novel['desc'], novel['rating'], novel_id))
        else:
            print(f"  添加新小说...")
            cursor.execute('''
                INSERT INTO novels (title, author, cover_url, description, rating, source_url)
                VALUES (?, ?, ?, ?, ?, ?)
            ''', (novel['title'], novel['author'], cover_url, novel['desc'], novel['rating'], 
                  f'https://example.com/{novel["title"]}'))
            novel_id = cursor.lastrowid
        
        # 添加章节
        cursor.execute('SELECT COUNT(*) FROM chapters WHERE novel_id=?', (novel_id,))
        if cursor.fetchone()[0] == 0:
            print(f"  添加章节...")
            cursor.execute('''
                INSERT INTO chapters (novel_id, chapter_number, title, content)
                VALUES (?, 1, ?, ?)
            ''', (novel_id, novel['chapter'], novel['content']))
    
    conn.commit()
    conn.close()
    print("\n✅ 完成！10本小说已添加")

if __name__ == '__main__':
    main()
